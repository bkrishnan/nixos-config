
# ğŸ—‚ï¸ NixOS Configuration

A modular, flake-based NixOS configuration using **Home Manager** (integrated as a NixOS module). Designed to support multiple machines â€” a shared base config, per-machine hardware modules, and per-device declarations all live in dedicated folders.

## Repository Structure

```
.
â”œâ”€â”€ flake.nix                   # Entry point â€” pins nixpkgs + home-manager
â”œâ”€â”€ configuration.nix           # Shared system config (services, fonts, users, â€¦)
â”œâ”€â”€ hardware-configuration.nix  # Auto-generated by nixos-generate-config â€” do not edit
â”œâ”€â”€ home.nix                    # Home Manager root â€” imports home/programs/
â”‚
â”œâ”€â”€ hosts/                      # Per-machine hardware modules
â”‚   â””â”€â”€ imac/
â”‚       â”œâ”€â”€ hardware.nix        # iMac GPU, Wi-Fi, ZFS, kernel params
â”‚       â””â”€â”€ README.md           # iMac-specific notes and rationale
â”‚
â”œâ”€â”€ devices/                    # Per-device NixOS modules + documentation
â”‚   â”œâ”€â”€ brother-printer.nix     # Brother HL-L2300D (IPP network printer)
â”‚   â”œâ”€â”€ brother-printer.md
â”‚   â”œâ”€â”€ brother-scanner.nix     # Brother MFC-J410W (brscan4 network scanner)
â”‚   â””â”€â”€ brother-scanner.md
â”‚
â”œâ”€â”€ home/
â”‚   â””â”€â”€ programs/               # Modular Home Manager program declarations
â”‚       â”œâ”€â”€ packages.nix
â”‚       â”œâ”€â”€ fish.nix
â”‚       â”œâ”€â”€ git.nix
â”‚       â”œâ”€â”€ emacs.nix
â”‚       â”œâ”€â”€ vscode.nix
â”‚       â”œâ”€â”€ hyprland.nix
â”‚       â”œâ”€â”€ i3.nix
â”‚       â””â”€â”€ â€¦
â”‚
â””â”€â”€ config/                     # Raw config files (non-Nix) sourced by Home Manager
    â””â”€â”€ emacs/
        â””â”€â”€ init.el
```

## Design Principles

### Shared vs. Machine-Specific

`configuration.nix` holds everything common across all machines: users, locale, fonts, shell, core services, and Home Manager wiring. Machine-specific tweaks (GPU drivers, kernel params, Wi-Fi firmware) live in `hosts/<hostname>/hardware.nix` and are imported in `configuration.nix`.

### Adding a New Machine

1. Create `hosts/<hostname>/hardware.nix` with the machine's hardware-specific config.
2. Add a new `nixosConfigurations.<hostname>` entry to `flake.nix`, importing both `configuration.nix` and `hosts/<hostname>/hardware.nix`.
3. Document it in `hosts/<hostname>/README.md`.

```bash
sudo nixos-rebuild switch --flake .#<hostname>
```

### External Devices

Each peripheral gets its own file in `devices/`. The `.nix` file is imported in `configuration.nix`; the `.md` file documents setup and troubleshooting.

### Home Manager

Home Manager runs as a NixOS module (no separate activation step needed). Program config lives in `home/programs/`; complex native-language configs live in `config/<program>/` and are sourced via `home.file`.

## Hosts

| Hostname | Machine | Notes |
|----------|---------|-------|
| `imac` | Late 2012 iMac 27-inch | Hybrid Intel/NVIDIA (Nouveau), Broadcom Wi-Fi â€” [README](./hosts/imac/README.md) |

## External Devices

| Device | Type | Config | Docs |
|--------|------|--------|------|
| Brother HL-L2300D | Network printer | [brother-printer.nix](./devices/brother-printer.nix) | [brother-printer.md](./devices/brother-printer.md) |
| Brother MFC-J410W | Network scanner | [brother-scanner.nix](./devices/brother-scanner.nix) | [brother-scanner.md](./devices/brother-scanner.md) |

## Core Tools

- **Compositor:** Hyprland (Wayland) + i3 (X11 fallback)
- **Login Manager:** Ly TUI
- **Terminals:** Alacritty, Foot
- **Shell:** Fish
- **Editor:** Emacs (declarative packages via `emacsWithPackages`), VS Code

## Build & Deploy

```bash
# Rebuild and switch (primary workflow)
sudo nixos-rebuild switch --flake .#imac

# Test without making it the boot default
sudo nixos-rebuild test --flake .#imac

# Build without activating
sudo nixos-rebuild build --flake .#imac

# Update flake inputs to latest
nix flake update

# Garbage-collect old generations
sudo nix-collect-garbage -d
```

## Workflow

1. **System changes** â†’ edit `configuration.nix` or files under `hosts/` / `devices/` â†’ `sudo nixos-rebuild switch --flake .#imac`
2. **User/program changes** â†’ edit files in `home/programs/` or `home.nix` â†’ same rebuild picks them up
3. **Commit** â†’ `git add . && git commit -m "â€¦"` to track history

"Turning a legacy iMac into a future-proof Linux workstation, one GPU at a time."