# Copilot Instructions — nixos-config

## Architecture

This is a **multi-host NixOS Flake** configuration managed by user `bkrishnan`, running NixOS 25.11. It uses **Home Manager** (integrated as a NixOS module) to manage user-level dotfiles declaratively. The repo is designed to support multiple machines: shared base config lives in `configuration.nix`, machine-specific hardware tweaks in `hosts/<hostname>/hardware.nix`, and per-device declarations in `devices/`.

### File Hierarchy

- `flake.nix` — Entry point. Pins `nixpkgs` (nixos-25.11) and `home-manager` (release-25.11). Defines one `nixosConfigurations` entry per host (currently: `imac`).
- `configuration.nix` — Shared system-level config: services (Hyprland, i3, GNOME, Ly), system packages, fonts, users, shell, ZFS/zram defaults, and Home Manager wiring. Imported by every host.
- `hardware-configuration.nix` — Auto-generated by `nixos-generate-config`. **Do not edit.**
- `hosts/<hostname>/hardware.nix` — Machine-specific hardware config: GPU drivers, kernel modules/params, Wi-Fi firmware, `networking.hostId`, etc. Each host has its own subdirectory.
- `devices/*.nix` — Per-peripheral NixOS modules (printers, scanners, etc.). Imported in `configuration.nix`.
- `home.nix` — Home Manager root for user `bkrishnan`. Imports all modules from `home/programs/`.
- `home/programs/*.nix` — Modular per-program Nix declarations (one concern per file).
- `config/` — Raw configuration files (non-Nix, in program-native languages) sourced by Home Manager modules:
  - `config/emacs/init.el` — Emacs Lisp configuration with use-package declarations, Org-mode setup, Denote bindings.
  - Additional program configs follow this structure as needed.

### Key Design Decisions

- **Shared vs. machine-specific**: `configuration.nix` holds everything common to all hosts. Hardware quirks (GPU drivers, kernel params, Wi-Fi firmware, `networking.hostId`) live in `hosts/<hostname>/hardware.nix` and are imported by the host's `nixosConfigurations` entry in `flake.nix`.
- **Adding a new host**: Create `hosts/<hostname>/hardware.nix`, add a `nixosConfigurations.<hostname>` block to `flake.nix` that imports both `configuration.nix` and the new hardware file, then set `networking.hostName` and `networking.hostId` inside it.
- **External devices**: Each peripheral has a `devices/<name>.nix` module (imported in `configuration.nix`) and a `devices/<name>.md` doc file alongside it.
- **Dual WM support**: Both Hyprland (Wayland) and i3 (X11) are configured. Ly display manager offers session selection. Hyprland is enabled at system level (`programs.hyprland.enable` in `configuration.nix`) and its user config is managed by Home Manager (`wayland.windowManager.hyprland` in `home/programs/hyprland.nix`).
- **System vs user packages**: System packages go in `configuration.nix` → `environment.systemPackages`. User packages go in `home/programs/packages.nix` → `home.packages`. Avoid duplicating packages across both.
- **ZFS + zram**: Enabled by default in `configuration.nix` for all hosts. Each host's `hardware.nix` must supply a unique `networking.hostId` (generate with `head -c4 /dev/urandom | od -A none -t x4`).

## Nix Language Conventions

- All `.nix` files use the standard module pattern: `{ pkgs, ... }: { ... }` (or `{ config, lib, pkgs, ... }:` when `lib`/`config` are needed).
- Use `with pkgs;` inside package lists for brevity (see `packages.nix`, `configuration.nix`).
- VS Code extensions are declared via `pkgs.vscode-extensions.<publisher>.<name>` in `vscode.nix`.
- `home.stateVersion` and `system.stateVersion` are both `"25.11"` — **never change these** unless performing a manual migration.

## Adding New Programs

### Nix-Only Approach (Simple Settings)

For programs with simple, declarative settings:

1. Create `home/programs/<program>.nix`:
   ```nix
   { pkgs, ... }:
   {
     programs.<program> = {
       enable = true;
       # settings...
     };
   }
   ```
2. Add the import to `home.nix`:
   ```nix
   imports = [
     ./home/programs/<program>.nix
     # ...existing imports
   ];
   ```

### Hybrid Approach (Nix + Static Config)

For complex programs with multi-line configurations (recommended for large config files):

1. Create the config directory: `mkdir -p config/<program>/`
2. Create raw config file: `config/<program>/config.ext` (e.g., `config.fish`, `init.el`, `init.toml`)
3. Create `home/programs/<program>.nix` with:
   - **Nix declarations** (packages, simple options)
   - **Home Manager file sourcing** to reference the raw config:
   ```nix
   { pkgs, ... }:
   {
     programs.<program> = {
       enable = true;
       # Nix-declarative settings
     };

     # Source raw config file (for complex configurations)
     home.file.".config/<program>/config" = {
       source = ../../config/<program>/config;
       onChange = "..."; # optional: reload command
     };
   }
   ```

Example: Emacs uses this hybrid approach:
- `home/programs/emacs.nix` — Declares packages via `emacsWithPackages` and sources `init.el`
- `config/emacs/init.el` — Contains Emacs Lisp code for org-mode, denote, vertico configuration

**When to use each approach:**
- **Pure Nix:** Settings that are simple, short, or can be represented cleanly in Nix (boolean flags, simple strings, lists)
- **Hybrid:** Complex configurations where native-language syntax is clearer (Emacs Lisp, shell functions, complex templates)

3. If the program needs a system-level service or daemon, configure that in `configuration.nix` instead.

## Build & Deploy

```bash
# Rebuild and switch (primary workflow) — replace <hostname> with e.g. imac
sudo nixos-rebuild switch --flake .#<hostname>

# Test without making it the boot default
sudo nixos-rebuild test --flake .#<hostname>

# Build without activating (dry run)
sudo nixos-rebuild build --flake .#<hostname>

# Update flake inputs (nixpkgs, home-manager) to latest
nix flake update

# Garbage-collect old generations and store paths
sudo nix-collect-garbage -d
```

All commands must be run from the repo root (`~/nixos-config`). The hostname must match `networking.hostName` set in the host's `hardware.nix` and the key in `nixosConfigurations` in `flake.nix`.

## Critical Constraints

- **ZFS hostId**: Every host must declare `networking.hostId` in its `hosts/<hostname>/hardware.nix`. Do not remove it — ZFS will refuse to import pools without it.
- **Fish shell**: Default shell for user `bkrishnan`. Enabled at both system level (`programs.fish.enable`) and Home Manager level.
- **stateVersion**: `home.stateVersion` and `system.stateVersion` are both `"25.11"` — never change these unless performing a deliberate migration.
- **iMac-specific (hosts/imac/hardware.nix)**: Nouveau driver (not proprietary NVIDIA — blacklisted); Broadcom BCM4331 Wi-Fi via `broadcom-sta` (marked insecure, allowed by `allowInsecurePredicate`); open-source Wi-Fi drivers (`b43`/`bcma`/`brcmsmac`) blacklisted. These constraints apply only to the `imac` host.
