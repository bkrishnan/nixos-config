# Copilot Instructions — nixos-config

## Architecture

This is a **NixOS Flake** configuration for a 2012 iMac (13,2) running NixOS 25.11 with a hybrid Intel/NVIDIA GPU setup. It uses **Home Manager** (integrated as a NixOS module) to manage user-level dotfiles declaratively.

### File Hierarchy

- `flake.nix` — Entry point. Pins `nixpkgs` (nixos-25.11) and `home-manager` (release-25.11). Defines a single host: `imac`.
- `configuration.nix` — System-level config: boot, kernel modules, GPU drivers (Nouveau + Intel), services (Hyprland, i3, GNOME, Ly display manager), system packages, and environment variables.
- `hardware-configuration.nix` — Auto-generated by `nixos-generate-config`. **Do not edit.**
- `home.nix` — Home Manager root for user `bkrishnan`. Imports all modules from `home/programs/`.
- `home/programs/*.nix` — Modular per-program Nix declarations (one concern per file).
- `config/` — Raw configuration files (non-Nix, in program-native languages) sourced by Home Manager modules:
  - `config/emacs/init.el` — Emacs Lisp configuration with use-package declarations, Org-mode setup, Denote bindings.
  - Additional program configs follow this structure as needed.

### Key Design Decisions

- **Dual GPU load-balancing**: NVIDIA GTX 680MX (Nouveau/NVE4) renders the desktop; Intel HD 4000 (i915) handles VA-API video decoding. This split is enforced via `AQ_DRM_DEVICES` and `LIBVA_DRIVER_NAME` in `configuration.nix`.
- **Dual WM support**: Both Hyprland (Wayland) and i3 (X11) are configured. Ly display manager offers session selection. Hyprland is enabled at system level (`programs.hyprland.enable` in `configuration.nix`) and its user config is managed by Home Manager (`wayland.windowManager.hyprland` in `home/programs/hyprland.nix`).
- **System vs user packages**: System packages go in `configuration.nix` → `environment.systemPackages`. User packages go in `home/programs/packages.nix` → `home.packages`. Avoid duplicating packages across both.

## Nix Language Conventions

- All `.nix` files use the standard module pattern: `{ pkgs, ... }: { ... }` (or `{ config, lib, pkgs, ... }:` when `lib`/`config` are needed).
- Use `with pkgs;` inside package lists for brevity (see `packages.nix`, `configuration.nix`).
- VS Code extensions are declared via `pkgs.vscode-extensions.<publisher>.<name>` in `vscode.nix`.
- `home.stateVersion` and `system.stateVersion` are both `"25.11"` — **never change these** unless performing a manual migration.

## Adding New Programs

### Nix-Only Approach (Simple Settings)

For programs with simple, declarative settings:

1. Create `home/programs/<program>.nix`:
   ```nix
   { pkgs, ... }:
   {
     programs.<program> = {
       enable = true;
       # settings...
     };
   }
   ```
2. Add the import to `home.nix`:
   ```nix
   imports = [
     ./home/programs/<program>.nix
     # ...existing imports
   ];
   ```

### Hybrid Approach (Nix + Static Config)

For complex programs with multi-line configurations (recommended for large config files):

1. Create the config directory: `mkdir -p config/<program>/`
2. Create raw config file: `config/<program>/config.ext` (e.g., `config.fish`, `init.el`, `init.toml`)
3. Create `home/programs/<program>.nix` with:
   - **Nix declarations** (packages, simple options)
   - **Home Manager file sourcing** to reference the raw config:
   ```nix
   { pkgs, ... }:
   {
     programs.<program> = {
       enable = true;
       # Nix-declarative settings
     };

     # Source raw config file (for complex configurations)
     home.file.".config/<program>/config" = {
       source = ../../config/<program>/config;
       onChange = "..."; # optional: reload command
     };
   }
   ```

Example: Emacs uses this hybrid approach:
- `home/programs/emacs.nix` — Declares packages via `emacsWithPackages` and sources `init.el`
- `config/emacs/init.el` — Contains Emacs Lisp code for org-mode, denote, vertico configuration

**When to use each approach:**
- **Pure Nix:** Settings that are simple, short, or can be represented cleanly in Nix (boolean flags, simple strings, lists)
- **Hybrid:** Complex configurations where native-language syntax is clearer (Emacs Lisp, shell functions, complex templates)

3. If the program needs a system-level service or daemon, configure that in `configuration.nix` instead.

## Build & Deploy

```bash
# Rebuild and switch (primary workflow)
sudo nixos-rebuild switch --flake .#imac

# Test without making it the boot default
sudo nixos-rebuild test --flake .#imac

# Build without activating (dry run)
sudo nixos-rebuild build --flake .#imac

# Update flake inputs (nixpkgs, home-manager) to latest
nix flake update

# Garbage-collect old generations and store paths
sudo nix-collect-garbage -d
```

All commands must be run from the repo root (`~/nixos-config`). The flake host name is `imac` (must match `networking.hostName` in `configuration.nix`).

## Critical Constraints

- **Nouveau, not proprietary NVIDIA**: The proprietary `nvidia` modules are blacklisted in `boot.blacklistedKernelModules`. Never add `nvidia` to `services.xserver.videoDrivers`.
- **Broadcom Wi-Fi**: Uses `broadcom-sta` (allowed as insecure via `allowInsecurePredicate`). The open-source `b43`/`bcma`/`brcmsmac` drivers are blacklisted.
- **ZFS support**: Root is ext4 but ZFS tools are available. `networking.hostId` is required for ZFS — do not remove it.
- **Fish shell**: Default shell for user `bkrishnan`. Enabled at both system level (`programs.fish.enable`) and Home Manager level.
